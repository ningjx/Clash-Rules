name: Update Clash Rules

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  update-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    defaults:
      run:
        shell: bash
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --global init.defaultBranch master

      - name: Get latest release from Loyalsoldier/clash-rules
        id: get-release
        run: |
          # 获取最新release信息
          RELEASE_DATA=$(curl -s https://api.github.com/repos/Loyalsoldier/clash-rules/releases/latest)
          RELEASE_TAG=$(echo "$RELEASE_DATA" | jq -r '.tag_name')
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          
          # 获取所有非source code的asset下载URL
          echo "assets<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | test("^(?!.*source)") | . == true) | .browser_download_url' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "Latest release: $RELEASE_TAG"

      - name: Create temp directory and download files
        run: |
          mkdir -p /tmp/clash-rules-release
          cd /tmp/clash-rules-release
          
          # 下载所有asset文件（排除source code）
          curl -s https://api.github.com/repos/Loyalsoldier/clash-rules/releases/latest | \
          jq -r '.assets[] | select(.name | test("source", "i") | not) | .browser_download_url' | \
          while read url; do
            echo "Downloading: $url"
            curl -L -o "$(basename $url)" "$url"
          done
          
          # 解压所有压缩文件
          for file in *.tar.xz; do
            if [ -f "$file" ]; then
              echo "Extracting: $file"
              tar -xf "$file"
              rm "$file"
            fi
          done
          
          for file in *.zip; do
            if [ -f "$file" ]; then
              echo "Extracting: $file"
              unzip -q "$file"
              rm "$file"
            fi
          done
          
          # 列出下载的文件
          echo "Downloaded files:"
          find . -type f | head -20

      - name: Sync clash_rules files
        run: |
          CLASH_RULES_DIR="clash_rules"
          RELEASE_DIR="/tmp/clash-rules-release"
          
          # 创建clash_rules目录如果不存在
          mkdir -p "$CLASH_RULES_DIR"
          
          # 比对和同步文件
          # 1. 删除本地有但release中没有的文件
          if [ -d "$CLASH_RULES_DIR" ]; then
            find "$CLASH_RULES_DIR" -type f | while read local_file; do
              relative_path="${local_file#$CLASH_RULES_DIR/}"
              release_file="$RELEASE_DIR/$relative_path"
              
              if [ ! -f "$release_file" ]; then
                echo "Removing: $relative_path"
                rm "$local_file"
              fi
            done
          fi
          
          # 2. 添加或更新文件
          find "$RELEASE_DIR" -type f 2>/dev/null | while read release_file; do
            relative_path="${release_file#$RELEASE_DIR/}"
            local_file="$CLASH_RULES_DIR/$relative_path"
            
            # 创建目录
            mkdir -p "$(dirname "$local_file")"
            
            # 比较文件内容
            if [ ! -f "$local_file" ]; then
              echo "Adding: $relative_path"
              cp "$release_file" "$local_file"
            elif ! cmp -s "$release_file" "$local_file"; then
              echo "Updating: $relative_path"
              cp "$release_file" "$local_file"
            fi
          done

      - name: Commit and Push Changes
        run: |
          if ! git diff --quiet; then
            echo "Changes detected. Committing..."
            git add .
            
            # 获取release信息用于commit消息
            RELEASE_TAG=$(curl -s https://api.github.com/repos/Loyalsoldier/clash-rules/releases/latest | jq -r '.tag_name')
            git commit -m "chore: update clash-rules from $RELEASE_TAG on $(date +%Y%m%d%H%M)"
            
            # 推送回当前仓库
            git push origin HEAD:master
          else
            echo "No changes detected. Skipping commit."
          fi

      - name: Create summary
        if: always()
        run: |
          echo "## Clash Rules Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Sync completed" >> $GITHUB_STEP_SUMMARY
          echo "**Latest Release:** ${{ steps.get-release.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** [Loyalsoldier/clash-rules](https://github.com/Loyalsoldier/clash-rules)" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Time:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
